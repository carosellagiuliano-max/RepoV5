# Analytics & Reporting Documentation

## Overview

The Analytics & Reporting system provides comprehensive business intelligence for the hair salon management application. It offers real-time KPIs, detailed reports, and CSV export functionality to help salon owners make data-driven decisions.

## Features

### Key Performance Indicators (KPIs)

The system tracks the following essential metrics:

#### Appointment Metrics
- **Total Appointments**: Count of all appointments in the selected period
- **Booking Rate**: Percentage of appointments that were completed successfully
- **Cancellation Rate**: Percentage of appointments that were cancelled
- **Average Service Time**: Mean duration of completed appointments

#### Revenue Metrics
- **Total Revenue**: Sum of all completed appointment revenue
- **Daily Average Revenue**: Revenue divided by days in the period
- **Revenue Trends**: Daily revenue tracking over time

#### Staff Performance
- **Staff Utilization**: Percentage of appointments completed vs. scheduled per staff member
- **Staff Revenue**: Total revenue generated by each staff member
- **Staff Appointment Count**: Number of appointments handled by each staff member

#### Service Analytics
- **Popular Services**: Services ranked by booking frequency
- **Service Revenue**: Revenue generated by each service type
- **Service Performance**: Booking count and revenue per service

### Filtering Options

All analytics data can be filtered by:

- **Date Range**: Custom start and end dates
- **Quick Periods**: Today, This Week, This Month
- **Staff Member**: Filter data for specific staff members
- **Service Type**: Filter data for specific services

### Data Export

The system supports CSV export for three data types:

#### 1. Appointments Export
Contains detailed appointment information:
- Date and time
- Customer details (name, email)
- Staff member assigned
- Service details (name, duration, price)
- Appointment status
- Notes

#### 2. Staff Utilization Export
Contains staff performance metrics:
- Staff member name
- Total appointments
- Completed appointments
- Cancelled appointments
- Utilization percentage
- Working hours
- Revenue generated

#### 3. Services Revenue Export
Contains service performance data:
- Service name and category
- Number of bookings
- Total revenue
- Average price per booking

## API Endpoints

### GET `/admin/analytics/kpis`

Retrieves KPI data for the specified filters.

**Query Parameters:**
- `startDate` (optional): Start date in YYYY-MM-DD format
- `endDate` (optional): End date in YYYY-MM-DD format
- `staffId` (optional): UUID of specific staff member
- `serviceId` (optional): UUID of specific service
- `period` (optional): 'day', 'week', or 'month' (default: 'month')

**Response:**
```json
{
  "success": true,
  "data": {
    "totalAppointments": 150,
    "totalRevenue": 4500.00,
    "averageServiceTime": 45,
    "bookingRate": 85.5,
    "cancellationRate": 12.3,
    "staffUtilization": [...],
    "popularServices": [...],
    "dailyStats": [...],
    "period": "month",
    "dateRange": {
      "startDate": "2024-01-01",
      "endDate": "2024-01-31"
    }
  }
}
```

### GET `/admin/analytics/export`

Downloads CSV data for the specified type and filters.

**Query Parameters:**
- `type`: 'appointments', 'staff-utilization', or 'services-revenue'
- `startDate` (optional): Start date in YYYY-MM-DD format
- `endDate` (optional): End date in YYYY-MM-DD format
- `staffId` (optional): UUID of specific staff member
- `serviceId` (optional): UUID of specific service

**Response:**
- Content-Type: `text/csv; charset=utf-8`
- Content-Disposition: `attachment; filename="[type]_[dates].csv"`
- CSV data with localized German headers

## Frontend Components

### AnalyticsDashboard
Main dashboard component that orchestrates all analytics functionality.

**Features:**
- Tabbed interface for different analytics views
- Export buttons for CSV downloads
- Real-time data updates
- Error handling and loading states

### AnalyticsFilters
Filter component providing date range, staff, and service selection.

**Features:**
- Date picker for custom ranges
- Quick period selection (today, week, month)
- Staff member dropdown
- Service type dropdown
- Active filter indicators

### KPICards
Grid of cards displaying key performance indicators.

**Features:**
- Responsive grid layout
- Color-coded status indicators
- Trend visualization
- Formatted currency and percentages

### Charts
Interactive chart components for data visualization:

- **RevenueChart**: Line chart showing revenue trends over time
- **StaffUtilizationChart**: Bar charts and pie charts for staff performance
- **TopServicesChart**: Service performance visualization

## Database Views & Functions

The analytics system relies on the existing `appointments_with_details` view which joins:
- Appointments table
- Customer profiles
- Staff profiles
- Service details

### Recommended Database Optimizations

For production deployments, consider adding these database indexes:

```sql
-- Indexes for analytics performance
CREATE INDEX idx_appointments_start_time ON appointments(start_time);
CREATE INDEX idx_appointments_status ON appointments(status);
CREATE INDEX idx_appointments_staff_status ON appointments(staff_id, status);
CREATE INDEX idx_appointments_service_status ON appointments(service_id, status);
CREATE INDEX idx_appointments_date_range ON appointments(start_time, status) WHERE status IN ('completed', 'cancelled');
```

## Security & Authentication

- All analytics endpoints require admin or staff authentication
- JWT token validation with role-based access control
- Rate limiting: 60 requests per minute for KPIs, 20 requests per minute for exports
- Input validation using Zod schemas
- SQL injection protection through parameterized queries

## Performance Considerations

### Caching Strategy
- Client-side caching using SWR (React Query)
- Automatic cache invalidation on filter changes
- Stale-while-revalidate pattern for better UX

### Data Aggregation
- Server-side calculations for better performance
- Efficient database queries with proper indexing
- Pagination support for large datasets

### CSV Generation
- Server-side CSV generation to reduce client memory usage
- Streaming responses for large datasets
- Proper file naming with timestamps

## Error Handling

The system includes comprehensive error handling:

### Client-Side
- Network error recovery with retry mechanisms
- User-friendly error messages in German
- Loading states during data fetching
- Graceful degradation when data is unavailable

### Server-Side
- Structured error responses with error codes
- Request validation and sanitization
- Database error handling
- Rate limiting with appropriate HTTP status codes

## Localization

All user-facing text is in German:
- KPI labels and descriptions
- Filter options and placeholders
- Export file headers
- Error messages and notifications
- Date and currency formatting (Swiss locale)

## Testing

### Unit Tests
- Component rendering and functionality
- KPI calculation accuracy
- Filter functionality
- Export generation

### Integration Tests
- API endpoint validation
- Database query testing
- CSV export format verification
- Authentication and authorization

### E2E Tests
- Complete user workflows
- Export functionality
- Filter interactions
- Error scenarios

## Future Enhancements

Potential improvements for future versions:

1. **Advanced Analytics**
   - Customer retention metrics
   - Seasonal trend analysis
   - Predictive analytics for booking patterns
   - Revenue forecasting

2. **Visualization Enhancements**
   - Heat maps for appointment patterns
   - Geographic analysis if multiple locations
   - Real-time dashboard updates
   - Custom chart configurations

3. **Export Improvements**
   - Excel format support
   - PDF report generation
   - Scheduled report delivery
   - Custom report templates

4. **Performance Optimizations**
   - Data warehouse integration
   - Pre-computed aggregates
   - Background report generation
   - Advanced caching strategies